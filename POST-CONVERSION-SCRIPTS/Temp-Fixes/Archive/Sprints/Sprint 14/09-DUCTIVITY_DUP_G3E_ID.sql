SET ECHO ON
SET LINESIZE 1000
SET PAGESIZE 300
SET TRIMSPOOL ON
SPOOL DUCTIVITY_DUP_G3E_ID.LOG

CREATE TABLE GIS.B$DUCTIVITY_N_DUPS_TEMP AS
  SELECT   G3E_ID
    ,G3E_FNO
    ,G3E_CNO
    ,G3E_FID
    ,LTT_ID
    ,LTT_TID
    ,IDCOUNT
    ,FIDRANK
    FROM
      (SELECT   COUNT ( *) OVER (PARTITION BY DUCT.G3E_ID) IDCOUNT
        ,DENSE_RANK () OVER (PARTITION BY DUCT.G3E_ID ORDER BY DUCT.G3E_FID) FIDRANK
        ,DUCT.*
        FROM B$DUCTIVITY_N DUCT
        WHERE 1          = 1
          AND DUCT.LTT_ID = 0
      ) D
    WHERE 1         = 1
      AND D.IDCOUNT > 1
      AND D.FIDRANK > 1;

ALTER TABLE B$DUCTIVITY_N DISABLE ALL TRIGGERS;

UPDATE GIS.B$DUCTIVITY_N DUCT
  SET DUCT.G3E_ID = GIS.B$COMMON_N_PKG.GETSEQUENCEVALUE
  WHERE EXISTS
    (SELECT   1
      FROM GIS.B$DUCTIVITY_N_DUPS_TEMP D
      WHERE 1            = 1
        AND DUCT.G3E_ID  = D.G3E_ID
        AND DUCT.G3E_FNO = D.G3E_FNO
        AND DUCT.G3E_CNO = D.G3E_CNO
        AND DUCT.G3E_FID = D.G3E_FID
        AND DUCT.LTT_ID  = D.LTT_ID
    ) ;
COMMIT;
ALTER TABLE B$DUCTIVITY_N ENABLE ALL TRIGGERS;

DROP TABLE GIS.B$DUCTIVITY_N_DUPS_TEMP;
SPOOL OFF; 