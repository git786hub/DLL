SET ECHO ON
SET LINESIZE 1000
SET PAGESIZE 300
SET TRIMSPOOL ON
SPOOL SINGLE_NODE_FEATURE_UPDATE.LOG

ALTER TABLE B$CONNECTIVITY_N DISABLE ALL TRIGGERS;

MERGE INTO B$CONNECTIVITY_N C1
USING
(
    SELECT DISTINCT CN.G3E_ID
        ,CN.G3E_FNO
        ,CN.G3E_CNO
        ,CN.G3E_FID
        ,CN.G3E_CID
        ,CASE 
                WHEN CN.NODE_1_ID = 0 AND CN.NODE_2_ID <> 0 THEN CN.NODE_2_ID
                ELSE CN.NODE_1_ID
            END NODE_1_ID
        ,CASE 
                WHEN CN.NODE_2_ID = 0 AND CN.NODE_1_ID <> 0 THEN CN.NODE_1_ID
                ELSE CN.NODE_2_ID
            END NODE_2_ID
    FROM B$CONNECTIVITY_N CN
    JOIN G3E_FEATURE FT ON CN.G3E_FNO = FT.G3E_FNO
    WHERE 1=1
        AND FT.G3E_NUMBEROFNODES = 1
        AND CN.NODE_1_ID <> CN.NODE_2_ID
        AND CN.LTT_ID = 0
) C2
ON 
( 
        C1.G3E_ID   = C2.G3E_ID 
    AND C1.G3E_FNO  = C2.G3E_FNO
    AND C1.G3E_CNO  = C2.G3E_CNO
    AND C1.G3E_FID  = C2.G3E_FID
    AND C1.G3E_CID  = C2.G3E_CID
)
WHEN MATCHED THEN 
UPDATE SET
    C1.NODE_1_ID    = C2.NODE_1_ID
    ,C1.NODE_2_ID   = C2.NODE_2_ID
;

COMMIT;

ALTER TABLE B$CONNECTIVITY_N ENABLE ALL TRIGGERS;

SPOOL OFF;
